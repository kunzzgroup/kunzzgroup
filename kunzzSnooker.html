<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kunzz Holdings - Professional Snooker</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a5c3a 0%, #0f3d26 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .company-name {
            font-size: 42px;
            font-weight: bold;
            color: #fbbf24;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            letter-spacing: 2px;
        }
        
        .game-title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-top: 8px;
        }
        
        .game-container {
            background: linear-gradient(to bottom, #ffffff, #f5f5f5);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            max-width: 1100px;
        }
        
        .menu {
            text-align: center;
            padding: 50px 30px;
        }
        
        .trophy {
            font-size: 80px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        h3 {
            font-size: 28px;
            margin: 20px 0;
            color: #1a5c3a;
        }
        
        .description {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        button {
            background: linear-gradient(135deg, #16a34a 0%, #059669 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: linear-gradient(135deg, #15803d 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .game-layout {
            display: grid;
            grid-template-columns: 840px 220px;
            gap: 20px;
        }
        
        .main-area {
            display: flex;
            flex-direction: column;
        }
        
        .scoreboard {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            padding: 15px;
            border-radius: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .player-score {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .player-score.active-player {
            background: white;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }
        
        .player-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .score {
            font-size: 36px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        
        .active {
            color: #16a34a;
        }
        
        .inactive {
            color: #d1d5db;
        }
        
        #snookerCanvas {
            border: 6px solid #78350f;
            border-radius: 12px;
            cursor: crosshair;
            display: block;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            background: #0f4a2a;
        }
        
        .message {
            text-align: center;
            margin-top: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #1a5c3a;
            min-height: 30px;
            padding: 8px;
            background: rgba(22, 163, 74, 0.1);
            border-radius: 8px;
        }
        
        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .control-section {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .control-title {
            font-size: 16px;
            font-weight: bold;
            color: #1a5c3a;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .power-input-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .power-input {
            width: 80px;
            padding: 8px;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #16a34a;
            border-radius: 8px;
            text-align: center;
        }
        
        .power-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }
        
        .unit-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }
        
        .shoot-button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            font-size: 16px;
        }
        
        .shoot-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }
        
        .spin-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .spin-selector {
            width: 160px;
            height: 160px;
            position: relative;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 50%;
            border: 3px solid #16a34a;
            cursor: crosshair;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .spin-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid #16a34a;
            border-radius: 50%;
        }
        
        .spin-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #DC2626;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        .spin-labels {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .spin-label {
            position: absolute;
            font-size: 11px;
            font-weight: bold;
            color: #666;
        }
        
        .spin-label.top { top: 5px; left: 50%; transform: translateX(-50%); }
        .spin-label.bottom { bottom: 5px; left: 50%; transform: translateX(-50%); }
        .spin-label.left { left: 5px; top: 50%; transform: translateY(-50%); }
        .spin-label.right { right: 5px; top: 50%; transform: translateY(-50%); }
        
        .spin-info {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        
        .spin-values {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
        
        .game-over {
            text-align: center;
            padding: 40px 30px;
        }
        
        .game-over-scores {
            margin: 20px 0;
            font-size: 20px;
            color: #333;
        }
        
        .game-over-scores div {
            margin: 10px 0;
        }
        
        .winner {
            font-size: 32px;
            color: #16a34a;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(22, 163, 74, 0.2);
        }
        
        .hint-text {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="company-name">ğŸ± Kunzz Holdings</div>
        <div class="game-title">Professional Snooker Pro</div>
    </div>
    
    <div class="game-container">
        <div id="menu" class="menu">
            <div class="trophy">ğŸ†</div>
            <h3>æ¬¢è¿æ¥åˆ°ä¸“ä¸šæ–¯è¯ºå…‹ï¼</h3>
            <p class="description">
                ğŸ± å›½é™…æ ‡å‡†æ‘†çƒè§„åˆ™<br>
                âš¡ æ•°å€¼åŠ›é‡æ§åˆ¶ç³»ç»Ÿ<br>
                ğŸ¯ ä¸“ä¸šåŠ å¡ç³»ç»Ÿ<br>
                ğŸ® çœŸå®ç‰©ç†å¼•æ“
            </p>
            <button onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        </div>
        
        <div id="gamePlay" class="hidden">
            <div class="game-layout">
                <div class="main-area">
                    <div class="scoreboard">
                        <div class="player-score" id="player1Panel">
                            <div class="player-label">ç©å®¶ 1</div>
                            <div id="score1" class="score active">0</div>
                        </div>
                        <div class="player-score" id="player2Panel">
                            <div class="player-label">ç©å®¶ 2</div>
                            <div id="score2" class="score inactive">0</div>
                        </div>
                    </div>
                    
                    <canvas id="snookerCanvas" width="840" height="420"></canvas>
                    
                    <div class="message" id="message">ç„å‡†å¹¶è®¾ç½®åŠ›é‡å’ŒåŠ å¡ï¼</div>
                </div>
                
                <div class="controls-panel">
                    <div class="control-section">
                        <div class="control-title">âš¡ åŠ›é‡æ§åˆ¶</div>
                        <div class="power-input-section">
                            <div class="input-group">
                                <input 
                                    type="number" 
                                    id="powerInput" 
                                    class="power-input" 
                                    min="1" 
                                    max="100" 
                                    value="50"
                                    placeholder="50"
                                >
                                <span class="unit-label">å…«ä»™</span>
                            </div>
                            <button 
                                id="shootButton" 
                                class="shoot-button" 
                                onclick="shootBall()"
                            >
                                ğŸ± å‡»çƒ
                            </button>
                            <div class="hint-text">
                                è¾“å…¥ 1-100 çš„æ•°å€¼<br>
                                å»ºè®®ï¼šè½»æ‰“ 20-40ï¼Œé‡æ‰“ 60-80
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <div class="control-title">ğŸ¯ åŠ å¡æ§åˆ¶</div>
                        <div class="spin-section">
                            <div class="spin-selector" id="spinSelector">
                                <div class="spin-labels">
                                    <div class="spin-label top">é«˜æ†</div>
                                    <div class="spin-label bottom">ä½æ†</div>
                                    <div class="spin-label left">å·¦å¡</div>
                                    <div class="spin-label right">å³å¡</div>
                                </div>
                                <div class="spin-center"></div>
                                <div class="spin-marker" id="spinMarker"></div>
                            </div>
                            <div class="spin-info">
                                ç‚¹å‡»é€‰æ‹©å‡»çƒç‚¹
                            </div>
                            <div class="spin-values">
                                <span>æ¨ª: <span id="spinX">0</span></span>
                                <span>çºµ: <span id="spinY">0</span></span>
                            </div>
                            <div class="hint-text">
                                é«˜æ†ï¼šçƒåé€€<br>
                                ä½æ†ï¼šçƒè·Ÿè¿›<br>
                                ä¾§å¡ï¼šæ”¹å˜è§’åº¦
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="gameOver" class="game-over hidden">
            <div class="trophy">ğŸ†</div>
            <h3>æ¸¸æˆç»“æŸï¼</h3>
            <div class="game-over-scores">
                <div>ç©å®¶ 1: <span id="finalScore1">0</span> åˆ†</div>
                <div>ç©å®¶ 2: <span id="finalScore2">0</span> åˆ†</div>
            </div>
            <div class="winner" id="winner"></div>
            <button onclick="backToMenu()">å†ç©ä¸€å±€</button>
        </div>
    </div>

    <script>
        const gameState = {
            balls: [],
            cueBall: null,
            currentPlayer: 1,
            scores: { player1: 0, player2: 0 },
            angle: 0,
            shotTaken: false,
            animationFrame: null,
            hitCueBall: false,
            spinX: 0,
            spinY: 0,
            pottedThisTurn: [],
            cuePottedThisTurn: false
        };
        
        const config = {
            tableWidth: 840,
            tableHeight: 420,
            ballRadius: 10,
            friction: 0.985,
            spinFriction: 0.95,
            pocketRadius: 22,
            wallRestitution: 0.7,
            ballRestitution: 0.92,
            minVelocity: 0.02,
            spinEffect: 0.15
        };
        
        const pockets = [
            { x: 25, y: 25 },
            { x: config.tableWidth / 2, y: 18 },
            { x: config.tableWidth - 25, y: 25 },
            { x: 25, y: config.tableHeight - 25 },
            { x: config.tableWidth / 2, y: config.tableHeight - 18 },
            { x: config.tableWidth - 25, y: config.tableHeight - 25 }
        ];
        
        function startGame() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('gamePlay').classList.remove('hidden');
            document.getElementById('gameOver').classList.add('hidden');
            
            initGame();
            
            const canvas = document.getElementById('snookerCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!ctx) {
                console.error('æ— æ³•è·å–canvasä¸Šä¸‹æ–‡');
                return;
            }
            
            gameLoop(ctx);
        }
        
        function backToMenu() {
            document.getElementById('menu').classList.remove('hidden');
            document.getElementById('gamePlay').classList.add('hidden');
            document.getElementById('gameOver').classList.add('hidden');
            
            if (gameState.animationFrame) {
                cancelAnimationFrame(gameState.animationFrame);
            }
        }
        
        function initGame() {
            gameState.balls = [];
            gameState.scores = { player1: 0, player2: 0 };
            gameState.currentPlayer = 1;
            gameState.shotTaken = false;
            gameState.hitCueBall = false;
            gameState.spinX = 0;
            gameState.spinY = 0;
            gameState.pottedThisTurn = [];
            gameState.cuePottedThisTurn = false;
            updateSpinMarker();
            updateScoreDisplay();
            
            // å›½é™…æ–¯è¯ºå…‹æ ‡å‡†ä½ç½®ï¼ˆæŒ‰æ¯”ä¾‹ç¼©æ”¾åˆ°æˆ‘ä»¬çš„çƒå°ï¼‰
            const tableWidth = config.tableWidth;
            const tableHeight = config.tableHeight;
            
            // å…³é”®ä½ç½®ç‚¹
            const baulkLine = tableWidth * 0.29;  // å¼€çƒçº¿ï¼ˆè·åº•åº“29%ï¼‰
            const dRadius = tableHeight * 0.18;    // DåŒºåŠå¾„ï¼ˆä¿®æ­£ä¸ºæ›´æ¥è¿‘æ ‡å‡†ï¼‰
            const centreSpot = tableWidth / 2;     // ä¸­å¿ƒç‚¹
            const pyramidSpot = tableWidth * 0.77; // é‡‘å­—å¡”ç‚¹ï¼ˆçº¢çƒé¡¶ç«¯ï¼‰
            const blackSpot = tableWidth * 0.87;   // é»‘çƒç‚¹
            
            let ballId = 0;
            
            // 1. æ‘†æ”¾15ä¸ªçº¢çƒï¼ˆæ ‡å‡†ç­‰è¾¹ä¸‰è§’å½¢ï¼Œé¡¶ç«¯åœ¨é‡‘å­—å¡”ç‚¹ï¼‰
            const redStartX = pyramidSpot;
            const redStartY = tableHeight / 2;
            const ballSpacing = config.ballRadius * 2.02; // çƒä¹‹é—´çš„é—´è·
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col <= row; col++) {
                    gameState.balls.push({
                        id: ballId++,
                        x: redStartX + row * config.ballRadius * 1.732, // âˆš3 â‰ˆ 1.732
                        y: redStartY + (col - row / 2) * ballSpacing,
                        vx: 0,
                        vy: 0,
                        spin: 0,
                        color: '#DC2626',
                        points: 1,
                        radius: config.ballRadius,
                        name: 'çº¢çƒ'
                    });
                }
            }
            
            // 2. æ‘†æ”¾å½©çƒï¼ˆæŒ‰å›½é™…è§„åˆ™ä½ç½®ï¼‰
            const coloredBalls = [
                { 
                    x: baulkLine, 
                    y: tableHeight / 2 + dRadius * 0.45, 
                    color: '#FCD34D', 
                    points: 2,
                    name: 'é»„çƒ'
                },
                { 
                    x: baulkLine, 
                    y: tableHeight / 2 - dRadius * 0.45, 
                    color: '#10B981', 
                    points: 3,
                    name: 'ç»¿çƒ'
                },
                { 
                    x: baulkLine, 
                    y: tableHeight / 2, 
                    color: '#92400E', 
                    points: 4,
                    name: 'æ£•çƒ'
                },
                { 
                    x: centreSpot, 
                    y: tableHeight / 2, 
                    color: '#1E40AF', 
                    points: 5,
                    name: 'è“çƒ'
                },
                { 
                    x: (centreSpot + pyramidSpot) / 2, // ç²‰çƒåœ¨è“çƒä¸çº¢çƒé¡¶ç‚¹ä¹‹é—´
                    y: tableHeight / 2, 
                    color: '#EC4899', 
                    points: 6,
                    name: 'ç²‰çƒ'
                },
                { 
                    x: blackSpot, 
                    y: tableHeight / 2, 
                    color: '#1F2937', 
                    points: 7,
                    name: 'é»‘çƒ'
                }
            ];
            
            coloredBalls.forEach(ball => {
                gameState.balls.push({
                    id: ballId++,
                    x: ball.x,
                    y: ball.y,
                    vx: 0,
                    vy: 0,
                    spin: 0,
                    color: ball.color,
                    points: ball.points,
                    radius: config.ballRadius,
                    name: ball.name
                });
            });
            
            // 3. æ¯çƒï¼ˆç™½çƒï¼‰æ”¾åœ¨DåŒºå†…
            gameState.cueBall = {
                x: baulkLine,
                y: tableHeight / 2 + dRadius * 0.6,
                vx: 0,
                vy: 0,
                spinX: 0,
                spinY: 0,
                color: '#FFFFFF',
                radius: config.ballRadius,
                name: 'æ¯çƒ'
            };
            
            // éªŒè¯æ‰€æœ‰çƒçš„åæ ‡éƒ½æ˜¯æœ‰æ•ˆçš„
            let validBalls = 0;
            gameState.balls.forEach(ball => {
                if (isFinite(ball.x) && isFinite(ball.y) && isFinite(ball.radius)) {
                    validBalls++;
                }
            });
            console.log(`åˆå§‹åŒ–å®Œæˆï¼š${validBalls} ä¸ªæœ‰æ•ˆçƒï¼Œæ¯çƒä½ç½®: (${gameState.cueBall.x.toFixed(1)}, ${gameState.cueBall.y.toFixed(1)})`);
            
            updateMessage("ç©å®¶ 1 çš„å›åˆ - å›½é™…æ ‡å‡†æ‘†çƒ");
        }
        
        function updateScoreDisplay() {
            document.getElementById('score1').textContent = gameState.scores.player1;
            document.getElementById('score2').textContent = gameState.scores.player2;
            
            const player1Panel = document.getElementById('player1Panel');
            const player2Panel = document.getElementById('player2Panel');
            
            if (gameState.currentPlayer === 1) {
                document.getElementById('score1').className = 'score active';
                document.getElementById('score2').className = 'score inactive';
                player1Panel.classList.add('active-player');
                player2Panel.classList.remove('active-player');
            } else {
                document.getElementById('score1').className = 'score inactive';
                document.getElementById('score2').className = 'score active';
                player1Panel.classList.remove('active-player');
                player2Panel.classList.add('active-player');
            }
        }
        
        function updateMessage(msg) {
            document.getElementById('message').textContent = msg;
        }
        
        function shootBall() {
            if (!gameState.cueBall || ballsMoving() || 
                !isFinite(gameState.cueBall.x) || !isFinite(gameState.cueBall.y)) {
                return;
            }
            
            const powerInput = document.getElementById('powerInput');
            let power = parseInt(powerInput.value) || 50;
            power = Math.max(1, Math.min(100, power));
            
            gameState.shotTaken = true;
            gameState.hitCueBall = true;
            gameState.pottedThisTurn = [];
            gameState.cuePottedThisTurn = false;
            
            const finalPower = power / 8;
            gameState.cueBall.vx = Math.cos(gameState.angle) * finalPower;
            gameState.cueBall.vy = Math.sin(gameState.angle) * finalPower;
            gameState.cueBall.spinX = gameState.spinX * config.spinEffect;
            gameState.cueBall.spinY = gameState.spinY * config.spinEffect;
            
            updateMessage(`å‡»çƒï¼åŠ›é‡ï¼š${power} å…«ä»™`);
        }
        
        function drawTable(ctx) {
            // å¤–è¾¹æ¡†
            ctx.fillStyle = '#0f4a2a';
            ctx.fillRect(0, 0, config.tableWidth, config.tableHeight);
            
            // å°é¢
            ctx.fillStyle = '#16a34a';
            ctx.fillRect(20, 20, config.tableWidth - 40, config.tableHeight - 40);
            
            // æœ¨è´¨è¾¹æ¡†
            ctx.strokeStyle = '#78350f';
            ctx.lineWidth = 40;
            ctx.strokeRect(0, 0, config.tableWidth, config.tableHeight);
            
            // æ ‡å‡†æ–¯è¯ºå…‹çº¿æ¡æ ‡è®°
            const baulkLine = config.tableWidth * 0.29;
            const dRadius = config.tableHeight * 0.18;
            
            // å¼€çƒçº¿ï¼ˆBaulk Lineï¼‰
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(baulkLine, 30);
            ctx.lineTo(baulkLine, config.tableHeight - 30);
            ctx.stroke();
            
            // DåŒºåŠåœ†ï¼ˆæœå‘çƒå°å†…ä¾§ï¼‰
            ctx.beginPath();
            ctx.arc(baulkLine, config.tableHeight / 2, dRadius, Math.PI / 2, -Math.PI / 2, true);
            ctx.stroke();
            
            // æ ‡è®°å…³é”®ä½ç½®ç‚¹ï¼ˆå°åœ†ç‚¹ï¼‰
            const spots = [
                { x: baulkLine, y: config.tableHeight / 2 },
                { x: config.tableWidth / 2, y: config.tableHeight / 2 },
                { x: config.tableWidth * 0.77, y: config.tableHeight / 2 },
                { x: config.tableWidth * 0.87, y: config.tableHeight / 2 }
            ];
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            spots.forEach(spot => {
                ctx.beginPath();
                ctx.arc(spot.x, spot.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // çƒè¢‹
            pockets.forEach(pocket => {
                const gradient = ctx.createRadialGradient(
                    pocket.x, pocket.y, 0,
                    pocket.x, pocket.y, config.pocketRadius
                );
                gradient.addColorStop(0, '#000000');
                gradient.addColorStop(1, '#1a1a1a');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(pocket.x, pocket.y, config.pocketRadius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = '#4a4a4a';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }
        
        function drawBalls(ctx) {
            const allBalls = [...gameState.balls];
            if (gameState.cueBall) allBalls.push(gameState.cueBall);
            
            allBalls.forEach(ball => {
                // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿çƒçš„å±æ€§éƒ½æ˜¯æœ‰æ•ˆçš„æ•°å­—
                if (!ball || typeof ball.x !== 'number' || typeof ball.y !== 'number' || 
                    !isFinite(ball.x) || !isFinite(ball.y) || 
                    !ball.radius || !isFinite(ball.radius)) {
                    return; // è·³è¿‡æ— æ•ˆçš„çƒ
                }
                
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 3;
                ctx.shadowOffsetY = 3;
                
                const gradient = ctx.createRadialGradient(
                    ball.x - ball.radius * 0.3,
                    ball.y - ball.radius * 0.3,
                    0,
                    ball.x,
                    ball.y,
                    ball.radius
                );
                
                if (ball.color === '#FFFFFF') {
                    gradient.addColorStop(0, '#FFFFFF');
                    gradient.addColorStop(1, '#E5E5E5');
                } else {
                    const lightColor = adjustBrightness(ball.color, 40);
                    gradient.addColorStop(0, lightColor);
                    gradient.addColorStop(1, ball.color);
                }
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.shadowColor = 'transparent';
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.lineWidth = 1.5;
                ctx.stroke();
                
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath();
                ctx.arc(ball.x - ball.radius * 0.35, ball.y - ball.radius * 0.35, ball.radius * 0.25, 0, Math.PI * 2);
                ctx.fill();
                
                if (ball === gameState.cueBall && (ball.spinX !== 0 || ball.spinY !== 0)) {
                    ctx.strokeStyle = 'rgba(220, 38, 38, 0.6)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(ball.x, ball.y);
                    ctx.lineTo(ball.x + ball.spinX * 15, ball.y + ball.spinY * 15);
                    ctx.stroke();
                }
            });
            
            ctx.shadowColor = 'transparent';
        }
        
        function adjustBrightness(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, (num >> 16) + amt);
            const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            const B = Math.min(255, (num & 0x0000FF) + amt);
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }
        
        function drawCueStick(ctx) {
            if (!gameState.cueBall || ballsMoving() || 
                !isFinite(gameState.cueBall.x) || !isFinite(gameState.cueBall.y)) {
                return;
            }
            
            const cueLength = 180;
            const pullback = 15;
            const cueX = gameState.cueBall.x - Math.cos(gameState.angle) * cueLength;
            const cueY = gameState.cueBall.y - Math.sin(gameState.angle) * cueLength;
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(gameState.cueBall.x, gameState.cueBall.y);
            ctx.lineTo(
                gameState.cueBall.x + Math.cos(gameState.angle) * 150,
                gameState.cueBall.y + Math.sin(gameState.angle) * 150
            );
            ctx.stroke();
            ctx.setLineDash([]);
            
            const gradient = ctx.createLinearGradient(cueX, cueY, 
                gameState.cueBall.x - Math.cos(gameState.angle) * pullback,
                gameState.cueBall.y - Math.sin(gameState.angle) * pullback);
            gradient.addColorStop(0, '#78350f');
            gradient.addColorStop(0.7, '#92400e');
            gradient.addColorStop(1, '#f5f5dc');
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(cueX, cueY);
            ctx.lineTo(
                gameState.cueBall.x - Math.cos(gameState.angle) * pullback,
                gameState.cueBall.y - Math.sin(gameState.angle) * pullback
            );
            ctx.stroke();
        }
        
        function ballsMoving() {
            const allBalls = [...gameState.balls];
            if (gameState.cueBall) allBalls.push(gameState.cueBall);
            
            return allBalls.some(ball => {
                if (!ball || typeof ball.vx !== 'number' || typeof ball.vy !== 'number') {
                    return false;
                }
                return Math.abs(ball.vx) > config.minVelocity || 
                       Math.abs(ball.vy) > config.minVelocity;
            });
        }
        
        function updatePhysics() {
            const allBalls = [...gameState.balls];
            if (gameState.cueBall) allBalls.push(gameState.cueBall);
            
            const wasMoving = ballsMoving();
            
            allBalls.forEach(ball => {
                // å®‰å…¨æ£€æŸ¥
                if (!ball || typeof ball.x !== 'number' || typeof ball.y !== 'number') {
                    return;
                }

                // è¿›å…¥è¢‹å£åˆ™ç«‹å³ç§»é™¤ï¼Œé¿å…å¼¹å‡º
                let fellIntoPocket = false;
                for (const pocket of pockets) {
                    const dxP = ball.x - pocket.x;
                    const dyP = ball.y - pocket.y;
                    const distP = Math.sqrt(dxP * dxP + dyP * dyP);
                    if (distP <= config.pocketRadius - 2) {
                        fellIntoPocket = true;
                        break;
                    }
                }
                if (fellIntoPocket) {
                    if (ball === gameState.cueBall) {
                        gameState.cuePottedThisTurn = true;
                        // å°†æ¯çƒä¸´æ—¶ç§»å‡ºç”»å¸ƒ
                        gameState.cueBall.x = -1000;
                        gameState.cueBall.y = -1000;
                        gameState.cueBall.vx = 0;
                        gameState.cueBall.vy = 0;
                    } else {
                        gameState.pottedThisTurn.push(ball);
                        // ä»åœ¨åœºçƒåˆ—è¡¨ç§»é™¤
                        gameState.balls = gameState.balls.filter(b => b !== ball);
                    }
                    return; // æœ¬çƒå·²å…¥è¢‹ï¼Œä¸å†å‚ä¸ç¢°æ’/åå¼¹
                }
                
                if (Math.abs(ball.vx) > config.minVelocity || Math.abs(ball.vy) > config.minVelocity) {
                    if (ball === gameState.cueBall && (ball.spinX || ball.spinY)) {
                        ball.vx += ball.spinX * 0.05;
                        ball.vy += ball.spinY * 0.05;
                        ball.spinX *= config.spinFriction;
                        ball.spinY *= config.spinFriction;
                        
                        if (Math.abs(ball.spinX) < 0.01) ball.spinX = 0;
                        if (Math.abs(ball.spinY) < 0.01) ball.spinY = 0;
                    }
                    
                    ball.x += ball.vx;
                    ball.y += ball.vy;
                    ball.vx *= config.friction;
                    ball.vy *= config.friction;
                    
                    const minX = 20 + ball.radius;
                    const maxX = config.tableWidth - 20 - ball.radius;
                    const minY = 20 + ball.radius;
                    const maxY = config.tableHeight - 20 - ball.radius;
                    
                    if (ball.x < minX || ball.x > maxX) {
                        ball.vx *= -config.wallRestitution;
                        ball.x = Math.max(minX, Math.min(maxX, ball.x));
                        if (ball === gameState.cueBall) {
                            ball.spinX *= -0.5;
                        }
                    }
                    if (ball.y < minY || ball.y > maxY) {
                        ball.vy *= -config.wallRestitution;
                        ball.y = Math.max(minY, Math.min(maxY, ball.y));
                        if (ball === gameState.cueBall) {
                            ball.spinY *= -0.5;
                        }
                    }
                } else {
                    ball.vx = 0;
                    ball.vy = 0;
                    if (ball === gameState.cueBall) {
                        ball.spinX = 0;
                        ball.spinY = 0;
                    }
                }
            });
            
            for (let i = 0; i < allBalls.length; i++) {
                for (let j = i + 1; j < allBalls.length; j++) {
                    const b1 = allBalls[i];
                    const b2 = allBalls[j];
                    
                    // å®‰å…¨æ£€æŸ¥
                    if (!b1 || !b2 || !isFinite(b1.x) || !isFinite(b1.y) || !isFinite(b2.x) || !isFinite(b2.y)) {
                        continue;
                    }
                    
                    const dx = b2.x - b1.x;
                    const dy = b2.y - b1.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const minDist = b1.radius + b2.radius;
                    
                    if (dist < minDist) {
                        const angle = Math.atan2(dy, dx);
                        const sin = Math.sin(angle);
                        const cos = Math.cos(angle);
                        
                        const v1x = b1.vx * cos + b1.vy * sin;
                        const v1y = b1.vy * cos - b1.vx * sin;
                        const v2x = b2.vx * cos + b2.vy * sin;
                        const v2y = b2.vy * cos - b2.vx * sin;
                        
                        const vx1Final = v2x;
                        const vx2Final = v1x;
                        
                        b1.vx = (vx1Final * cos - v1y * sin) * config.ballRestitution;
                        b1.vy = (v1y * cos + vx1Final * sin) * config.ballRestitution;
                        b2.vx = (vx2Final * cos - v2y * sin) * config.ballRestitution;
                        b2.vy = (v2y * cos + vx2Final * sin) * config.ballRestitution;
                        
                        if (b1 === gameState.cueBall && b1.spinX !== 0) {
                            b2.vx += b1.spinX * 0.3;
                        }
                        if (b1 === gameState.cueBall && b1.spinY !== 0) {
                            b2.vy += b1.spinY * 0.3;
                        }
                        
                        const overlap = minDist - dist;
                        const separateX = (dx / dist) * overlap * 0.5;
                        const separateY = (dy / dist) * overlap * 0.5;
                        b1.x -= separateX;
                        b1.y -= separateY;
                        b2.x += separateX;
                        b2.y += separateY;
                    }
                }
            }
            
            if (wasMoving && !ballsMoving() && gameState.shotTaken) {
                gameState.shotTaken = false;
                applyTurnResults();
            }
        }
        
        function applyTurnResults() {
            // å¤„ç†å›åˆç»“æœï¼šæ ¹æ®å…¥è¢‹åˆ—è¡¨è®¡åˆ†/çŠ¯è§„ï¼Œå¹¶å¤ä½æ¯çƒ
            if (gameState.cuePottedThisTurn) {
                const baulkLine = config.tableWidth * 0.29;
                const dRadius = config.tableHeight * 0.18;
                gameState.cueBall.x = baulkLine;
                gameState.cueBall.y = config.tableHeight / 2 + dRadius * 0.6;
                gameState.cueBall.vx = 0;
                gameState.cueBall.vy = 0;
                gameState.cueBall.spinX = 0;
                gameState.cueBall.spinY = 0;
                updateMessage('çŠ¯è§„ï¼æ¯çƒå…¥è¢‹ - å›åˆ°DåŒº');
                setTimeout(() => switchPlayer(), 1500);
            } else if (gameState.pottedThisTurn.length > 0 && gameState.hitCueBall) {
                let points = gameState.pottedThisTurn.reduce((sum, ball) => sum + ball.points, 0);
                gameState.scores['player' + gameState.currentPlayer] += points;
                updateScoreDisplay();
                updateMessage(`ç©å®¶ ${gameState.currentPlayer} å¾— ${points} åˆ†ï¼`);
            } else if (gameState.hitCueBall) {
                updateMessage('æœªè¿›çƒï¼Œæ¢äººï¼');
                setTimeout(() => switchPlayer(), 1500);
            } else {
                updateMessage('æœªå‡»ä¸­çƒï¼ŒçŠ¯è§„ï¼');
                setTimeout(() => switchPlayer(), 1500);
            }

            gameState.hitCueBall = false;
            gameState.pottedThisTurn = [];
            gameState.cuePottedThisTurn = false;

            if (gameState.balls.length === 0) {
                setTimeout(() => endGame(), 1000);
            }
        }
        
        function switchPlayer() {
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            updateScoreDisplay();
            updateMessage(`ç©å®¶ ${gameState.currentPlayer} çš„å›åˆ`);
        }
        
        function endGame() {
            if (gameState.animationFrame) {
                cancelAnimationFrame(gameState.animationFrame);
            }
            
            document.getElementById('finalScore1').textContent = gameState.scores.player1;
            document.getElementById('finalScore2').textContent = gameState.scores.player2;
            
            let winnerText = '';
            if (gameState.scores.player1 > gameState.scores.player2) {
                winnerText = 'ğŸ‰ ç©å®¶ 1 è·èƒœï¼';
            } else if (gameState.scores.player2 > gameState.scores.player1) {
                winnerText = 'ğŸ‰ ç©å®¶ 2 è·èƒœï¼';
            } else {
                winnerText = "ğŸ¤ å¹³å±€ï¼";
            }
            document.getElementById('winner').textContent = winnerText;
            
            document.getElementById('gamePlay').classList.add('hidden');
            document.getElementById('gameOver').classList.remove('hidden');
        }
        
        function gameLoop(ctx) {
            if (!ctx) {
                console.error('æ¸¸æˆå¾ªç¯ï¼šæ— æ•ˆçš„ä¸Šä¸‹æ–‡');
                return;
            }
            
            try {
                drawTable(ctx);
                updatePhysics();
                drawBalls(ctx);
                drawCueStick(ctx);
                
                const shootButton = document.getElementById('shootButton');
                if (shootButton) {
                    shootButton.disabled = ballsMoving();
                }
                
                gameState.animationFrame = requestAnimationFrame(() => gameLoop(ctx));
            } catch (error) {
                console.error('æ¸¸æˆå¾ªç¯é”™è¯¯:', error);
                if (gameState.animationFrame) {
                    cancelAnimationFrame(gameState.animationFrame);
                }
            }
        }
        
        const canvas = document.getElementById('snookerCanvas');
        
        canvas.addEventListener('mousemove', (e) => {
            if (!gameState.cueBall || ballsMoving() || 
                !isFinite(gameState.cueBall.x) || !isFinite(gameState.cueBall.y)) {
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // åªæœ‰å½“é¼ æ ‡åœ¨canvasèŒƒå›´å†…æ—¶æ‰æ›´æ–°è§’åº¦
            if (mouseX >= 0 && mouseX <= rect.width && mouseY >= 0 && mouseY <= rect.height) {
                gameState.angle = Math.atan2(mouseY - gameState.cueBall.y, mouseX - gameState.cueBall.x);
            }
        });
        
        const spinSelector = document.getElementById('spinSelector');
        const spinMarker = document.getElementById('spinMarker');
        
        function updateSpinMarker() {
            const centerX = 80;
            const centerY = 80;
            const markerX = centerX + gameState.spinX * 70;
            const markerY = centerY + gameState.spinY * 70;
            
            spinMarker.style.left = markerX + 'px';
            spinMarker.style.top = markerY + 'px';
            
            document.getElementById('spinX').textContent = gameState.spinX.toFixed(2);
            document.getElementById('spinY').textContent = gameState.spinY.toFixed(2);
        }
        
        spinSelector.addEventListener('click', (e) => {
            const rect = spinSelector.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const dx = x - centerX;
            const dy = y - centerY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const maxDist = centerX - 10;
            
            if (dist <= maxDist) {
                gameState.spinX = dx / maxDist;
                gameState.spinY = dy / maxDist;
            } else {
                gameState.spinX = (dx / dist) * (maxDist / maxDist);
                gameState.spinY = (dy / dist) * (maxDist / maxDist);
            }
            
            updateSpinMarker();
        });
        
        document.getElementById('powerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                shootBall();
            }
        });

        // å…è®¸ç‚¹å‡»ç”»å¸ƒæˆ–æŒ‰ç©ºæ ¼é”®å‡»çƒï¼Œå¹¶ç”¨æ–¹å‘é”®è°ƒèŠ‚åŠ›åº¦
        canvas.addEventListener('click', (e) => {
            // ä»…å½“é¼ æ ‡åœ¨canvaså†…ä¸”çƒé™æ­¢æ—¶å…è®¸ç‚¹å‡»å‡»çƒ
            if (!ballsMoving()) {
                shootBall();
            }
        });

        function clampPower(value) {
            return Math.max(1, Math.min(100, value));
        }

        function setPower(value) {
            const input = document.getElementById('powerInput');
            const next = clampPower(value);
            input.value = String(next);
        }

        document.addEventListener('keydown', (e) => {
            // é¿å…åœ¨è¾“å…¥æ¡†èšç„¦æ—¶ç”¨ç©ºæ ¼è§¦å‘é¡µé¢æ»šåŠ¨
            if (e.code === 'Space') {
                e.preventDefault();
                if (!ballsMoving()) {
                    shootBall();
                }
                return;
            }
            // æ–¹å‘é”®è°ƒèŠ‚åŠ›åº¦ï¼Œä¸æ”¹å˜é¼ æ ‡ä½ç½®ä»¥å…ç„å‡†çº¿åç§»
            const input = document.getElementById('powerInput');
            let current = parseInt(input.value) || 50;
            if (e.code === 'ArrowUp') {
                e.preventDefault();
                setPower(current + 5);
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                setPower(current - 5);
            }
        });
    </script>
</body>
</html>