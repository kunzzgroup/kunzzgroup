<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>赛马竞猜小游戏</title>
  <style>
    :root{
      --bg0:#070A14;
      --bg1:#0B1024;
      --panel:#0E1433CC;
      --panel2:#0B1024CC;
      --stroke:#2B3577;
      --stroke2:#3B48A6;
      --text:#EAF0FF;
      --muted:#A8B3E6;
      --good:#4EE6A8;
      --warn:#FFCE5C;
      --bad:#FF6B8B;
      --mana:#7CC3FF;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.45);
      --radius: 14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      background:
        radial-gradient(1200px 800px at 70% 10%, rgba(124,195,255,.18), transparent 55%),
        radial-gradient(900px 700px at 15% 85%, rgba(255,107,139,.14), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* subtle stars */
    body:before{
      content:"";
      position:fixed; inset:-40px;
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(2px 2px at 140px 90px, rgba(255,255,255,.12), transparent 55%),
        radial-gradient(1px 1px at 60px 160px, rgba(255,255,255,.12), transparent 55%),
        radial-gradient(1px 1px at 220px 210px, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(1px 1px at 300px 70px, rgba(255,255,255,.10), transparent 55%);
      background-size: 360px 260px;
      opacity:.7;
      filter: blur(.2px);
      animation: drift 18s linear infinite;
      pointer-events:none;
    }
    @keyframes drift{ from{ transform:translate3d(0,0,0);} to{ transform:translate3d(-120px,40px,0);} }

    /* FX layer */
    #fxLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index: 9999;
    }
    .cardGhost{
      position:fixed;
      transform-origin:center;
      animation: flyCard .42s cubic-bezier(.2,.9,.2,1) forwards;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
      will-change: transform, opacity;
    }
    @keyframes flyCard{
      0%{ transform: translate3d(0,0,0) rotate(0deg) scale(1); opacity: .95; }
      70%{ opacity: 1; }
      100%{ transform: translate3d(var(--dx), var(--dy), 0) rotate(var(--rot)) scale(.22); opacity: 0; }
    }
    .floatText{
      position:fixed;
      transform: translate(-50%, -50%);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing: .2px;
      border:1px solid rgba(59,72,166,.35);
      background: rgba(11,16,36,.65);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      animation: floatUp .72s ease-out forwards;
      will-change: transform, opacity;
      white-space: nowrap;
    }
    .floatText.bad{
      border-color: rgba(255,107,139,.40);
      background: rgba(60,10,20,.30);
      color: rgba(255,222,230,.98);
    }
    .floatText.good{
      border-color: rgba(78,230,168,.35);
      background: rgba(10,45,30,.28);
      color: rgba(219,255,242,.98);
    }
    @keyframes floatUp{
      0%{ transform: translate(-50%, -50%) scale(.95); opacity: 0; }
      12%{ opacity: 1; }
      100%{ transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.05); opacity: 0; }
    }
    .burst{
      position:fixed;
      width:0; height:0;
      transform: translate(-50%, -50%);
      animation: burstFade .46s ease-out forwards;
      will-change: transform, opacity;
    }
    .burst i{
      position:absolute;
      width: 7px; height: 7px;
      border-radius: 999px;
      background: rgba(124,195,255,.85);
      box-shadow: 0 0 0 3px rgba(124,195,255,.12);
      transform: translate3d(0,0,0) scale(var(--s));
      animation: particle .46s ease-out forwards;
      will-change: transform, opacity;
    }
    .burst.bad i{
      background: rgba(255,107,139,.9);
      box-shadow: 0 0 0 3px rgba(255,107,139,.14);
    }
    .burst.good i{
      background: rgba(78,230,168,.9);
      box-shadow: 0 0 0 3px rgba(78,230,168,.14);
    }
    @keyframes particle{
      0%{ transform: translate3d(0,0,0) scale(var(--s)); opacity: 1; }
      100%{ transform: translate3d(var(--dx), var(--dy), 0) scale(calc(var(--s) * .2)); opacity: 0; }
    }
    @keyframes burstFade{
      0%{ opacity: 1; }
      100%{ opacity: 0; }
    }

    #app{
      height:100vh;
      display:grid;
      grid-template-columns: 300px 1fr 360px;
      gap:14px;
      padding:14px;
    }

    .panel{
      border:1px solid rgba(59,72,166,.55);
      background: linear-gradient(180deg, var(--panel), rgba(10,14,40,.62));
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(59,72,166,.35);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    .panelHeader h3{
      margin:0;
      font-size:14px;
      letter-spacing:.8px;
      text-transform:uppercase;
      color:rgba(234,240,255,.92);
    }
    .panelBody{ padding:14px; }

    /* left stats */
    .kv{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0; }
    .k{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.6px; }
    .v{ font-variant-numeric: tabular-nums; font-weight:650; }

    .bar{
      height:10px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(59,72,166,.35);
      border-radius:999px;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }
    .bar > i{
      display:block; height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(124,195,255,.95), rgba(78,230,168,.85));
      border-radius:999px;
      transition: width .25s ease;
    }
    .bar.hp > i{ background: linear-gradient(90deg, rgba(255,107,139,.95), rgba(255,206,92,.85)); }
    .bar.block > i{ background: linear-gradient(90deg, rgba(124,195,255,.95), rgba(155,124,255,.85)); }

    .pills{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(59,72,166,.45);
      background: rgba(11,16,36,.7);
      color:rgba(234,240,255,.92);
      font-size:12px;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.25); box-shadow: 0 0 0 3px rgba(255,255,255,.06); }
    .dot.mana{ background: rgba(124,195,255,.95); box-shadow: 0 0 0 3px rgba(124,195,255,.12); }
    .dot.gold{ background: rgba(255,206,92,.95); box-shadow: 0 0 0 3px rgba(255,206,92,.12); }
    .dot.turn{ background: rgba(78,230,168,.95); box-shadow: 0 0 0 3px rgba(78,230,168,.12); }

    /* buttons */
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      user-select:none;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(59,72,166,.55);
      background: linear-gradient(180deg, rgba(27,32,80,.9), rgba(12,16,45,.95));
      color: rgba(234,240,255,.95);
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      font-weight:650;
      font-size:13px;
      letter-spacing:.3px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(124,195,255,.85); filter: brightness(1.05); }
    .btn:active{ transform: translateY(0); filter: brightness(0.98); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; filter:none; }
    .btn.primary{
      border-color: rgba(124,195,255,.75);
      background: linear-gradient(180deg, rgba(124,195,255,.22), rgba(27,32,80,.92));
    }

    /* center battlefield + hand */
    #center{
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .battlefield{
      flex: 1;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:12px;
      padding:14px;
    }
    .topHUD{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .energyPips{ display:flex; gap:6px; align-items:center; }
    .pip{
      width:14px; height:14px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(59,72,166,.5);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }
    .pip.on{
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.65), rgba(124,195,255,.9));
      border-color: rgba(124,195,255,.85);
      box-shadow: 0 0 0 3px rgba(124,195,255,.12);
    }

    .arena{
      position:relative;
      border-radius: var(--radius);
      border:1px solid rgba(59,72,166,.35);
      background:
        radial-gradient(900px 420px at 50% 40%, rgba(124,195,255,.12), transparent 60%),
        radial-gradient(700px 360px at 70% 75%, rgba(255,107,139,.10), transparent 60%),
        linear-gradient(180deg, rgba(8,10,20,.35), rgba(8,10,20,.60));
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 340px;
    }
    .arena:before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(255,255,255,.03) 1px, transparent 1px),
        linear-gradient(180deg, rgba(255,255,255,.02) 1px, transparent 1px);
      background-size: 46px 46px;
      opacity:.35;
      pointer-events:none;
    }

    .unit{
      position:absolute;
      width: 240px;
      border-radius: 18px;
      border:1px solid rgba(59,72,166,.35);
      background: linear-gradient(180deg, rgba(14,20,51,.62), rgba(8,10,20,.55));
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .unitHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(59,72,166,.25);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    .unitName{ font-weight:800; letter-spacing:.4px; }
    .unitTag{
      font-size:11px; color:rgba(234,240,255,.85);
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(59,72,166,.35);
      background: rgba(11,16,36,.55);
      white-space:nowrap;
    }
    .unitBody{ padding:12px; }
    .portrait{
      height:96px;
      border-radius:14px;
      border:1px solid rgba(59,72,166,.25);
      background:
        radial-gradient(110px 90px at 30% 20%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(135deg, rgba(124,195,255,.14), rgba(255,107,139,.10));
      position:relative;
      overflow:hidden;
    }
    .portrait:after{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(300px 160px at 30% 30%, rgba(124,195,255,.18), transparent 70%);
      transform: rotate(8deg);
    }

    .unitStats{ margin-top:10px; display:grid; gap:8px; }
    .mini{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      font-size:12px; color:rgba(234,240,255,.9);
    }
    .mini span{ color:var(--muted); }

    .unit.player{ left: 18px; bottom: 18px; }
    .unit.enemy{ right: 18px; top: 18px; width: 280px; }

    .shake{ animation: shake .22s ease; }
    @keyframes shake{
      0%{ transform: translate3d(0,0,0); }
      25%{ transform: translate3d(-3px,1px,0); }
      50%{ transform: translate3d(3px,-1px,0); }
      75%{ transform: translate3d(-2px,0,0); }
      100%{ transform: translate3d(0,0,0); }
    }
    .glowBad{ box-shadow: 0 0 0 2px rgba(255,107,139,.35), 0 18px 70px rgba(0,0,0,.55); }
    .glowGood{ box-shadow: 0 0 0 2px rgba(78,230,168,.28), 0 18px 70px rgba(0,0,0,.55); }

    /* battle log */
    .logWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 160px;
    }
    #log{
      height: 200px;
      overflow:auto;
      padding-right:8px;
      scrollbar-gutter: stable;
    }
    #log::-webkit-scrollbar{ width:10px; }
    #log::-webkit-scrollbar-thumb{ background: rgba(124,195,255,.16); border-radius:999px; border:1px solid rgba(59,72,166,.35); }
    .logItem{
      padding:10px 10px;
      margin:8px 0;
      border:1px solid rgba(59,72,166,.28);
      background: rgba(11,16,36,.55);
      border-radius: 12px;
      color: rgba(234,240,255,.92);
      line-height: 1.25;
    }
    .logItem small{ color: var(--muted); }

    /* hand + cards */
    .handDock{
      border-radius: var(--radius);
      border:1px solid rgba(59,72,166,.35);
      background: linear-gradient(180deg, rgba(14,20,51,.55), rgba(8,10,20,.62));
      box-shadow: var(--shadow2);
      padding: 12px;
    }
    #hand{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:stretch;
    }

    .card{
      width: 170px;
      border-radius: 16px;
      border:1px solid rgba(59,72,166,.55);
      background:
        radial-gradient(160px 120px at 30% 20%, rgba(255,255,255,.09), transparent 60%),
        linear-gradient(180deg, rgba(27,32,80,.95), rgba(12,16,45,.96));
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transform: translateY(0);
      transition: transform .14s ease, filter .14s ease, border-color .14s ease;
      user-select:none;
    }
    .card:hover{
      transform: translateY(-6px);
      border-color: rgba(124,195,255,.90);
      filter: brightness(1.04);
    }
    .card:active{ transform: translateY(-2px) scale(.99); }
    .card.disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      filter:none;
    }
    .cardTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px 0 10px;
    }
    .cost{
      width:28px; height:28px; border-radius:999px;
      display:grid; place-items:center;
      font-weight:900;
      color: rgba(8,10,20,.95);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(124,195,255,.95));
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .typeTag{
      font-size:11px;
      letter-spacing:.5px;
      text-transform:uppercase;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(59,72,166,.35);
      background: rgba(11,16,36,.55);
      color: rgba(234,240,255,.88);
    }
    .cardName{
      padding:8px 10px 0 10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .cardText{
      padding:10px;
      color: rgba(234,240,255,.88);
      font-size:12px;
      line-height:1.25;
    }
    .cardMeta{
      padding:10px;
      border-top:1px solid rgba(59,72,166,.20);
      display:flex;
      justify-content:space-between;
      color: var(--muted);
      font-size:11px;
    }

    /* right preview */
    .preview{
      border-radius: var(--radius);
      border:1px solid rgba(59,72,166,.35);
      background: rgba(11,16,36,.50);
      padding:12px;
    }
    .previewTitle{
      margin:0 0 8px 0;
      font-size:12px;
      color: rgba(234,240,255,.90);
      letter-spacing:.7px;
      text-transform:uppercase;
    }
    .previewHint{ color: var(--muted); font-size:12px; }
    .previewCard{ margin-top:10px; }

    /* Horse race */
    .field{ margin-top:12px; }
    .hint{ margin-top:6px; color: var(--muted); font-size:12px; line-height:1.2; }
    .input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(59,72,166,.45);
      background: rgba(11,16,36,.55);
      color: rgba(234,240,255,.95);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      font-weight:700;
      font-variant-numeric: tabular-nums;
    }
    .input:focus{ border-color: rgba(124,195,255,.75); }

    .horseGrid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .horseBtn{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(59,72,166,.45);
      background: rgba(11,16,36,.55);
      color: rgba(234,240,255,.92);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
      font-weight:800;
      font-size:12px;
      user-select:none;
    }
    .horseBtn:hover{ transform: translateY(-1px); border-color: rgba(124,195,255,.75); filter: brightness(1.04); }
    .horseBtn.active{
      border-color: rgba(124,195,255,.85);
      box-shadow: 0 0 0 3px rgba(124,195,255,.12);
    }
    .miniDot{
      width:12px; height:12px; border-radius:999px;
      background: var(--c, rgba(124,195,255,.9));
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--c) 18%, transparent);
      flex:0 0 auto;
    }

    .trackWrap{ display:flex; flex-direction:column; gap:12px; }
    .trackTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .track{
      --pad: 14px;
      --labelW: 58px;
      position:relative;
      border-radius: var(--radius);
      border:1px solid rgba(59,72,166,.35);
      background:
        radial-gradient(900px 420px at 50% 35%, rgba(124,195,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(8,10,20,.30), rgba(8,10,20,.62));
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: var(--pad);
      min-height: 460px;
    }
    .track:before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(255,255,255,.03) 1px, transparent 1px),
        linear-gradient(180deg, rgba(255,255,255,.02) 1px, transparent 1px);
      background-size: 46px 46px;
      opacity:.28;
      pointer-events:none;
    }
    .startLine, .finishLine{
      position:absolute;
      top: var(--pad);
      bottom: var(--pad);
      width: 2px;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 1px rgba(0,0,0,.35);
      pointer-events:none;
    }
    .startLine{ left: calc(var(--pad) + var(--labelW)); background: rgba(124,195,255,.35); }
    .finishLine{ right: var(--pad); background: rgba(255,206,92,.45); }
    .markers{
      position:absolute;
      top: var(--pad);
      bottom: var(--pad);
      left: calc(var(--pad) + var(--labelW));
      right: var(--pad);
      pointer-events:none;
      opacity:.25;
      background:
        linear-gradient(90deg, rgba(255,255,255,.22) 1px, transparent 1px);
      background-size: 25% 100%;
    }
    .lanes{
      position:relative;
      display:grid;
      gap: 10px;
      margin-top: 4px;
    }
    .lane{
      display:flex;
      align-items:center;
      gap:10px;
      height: 44px;
    }
    .laneLabel{
      width: var(--labelW);
      color: rgba(234,240,255,.85);
      font-weight:900;
      font-variant-numeric: tabular-nums;
      letter-spacing:.2px;
      text-align:right;
      padding-right: 6px;
    }
    .laneLine{
      position:relative;
      flex:1;
      height: 100%;
      border-radius: 12px;
      border:1px solid rgba(59,72,166,.20);
      background: rgba(11,16,36,.35);
      overflow:hidden;
    }
    .laneLine:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.06), transparent 40%, rgba(255,255,255,.05));
      opacity:.5;
      pointer-events:none;
    }
    .horseDot{
      position:absolute;
      left:0;
      top:50%;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      transform: translate3d(var(--x, 0px), -50%, 0);
      display:grid;
      place-items:center;
      font-weight: 1000;
      font-size: 12px;
      color: rgba(8,10,20,.95);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), color-mix(in srgb, var(--c) 85%, #000));
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 16px 36px rgba(0,0,0,.35), 0 0 0 3px color-mix(in srgb, var(--c) 18%, transparent);
      will-change: transform;
    }
    .horseDot.finished{
      box-shadow: 0 18px 48px rgba(0,0,0,.40), 0 0 0 5px rgba(255,206,92,.14);
    }

    .oddsBox{
      border-radius: var(--radius);
      border:1px solid rgba(59,72,166,.35);
      background: rgba(11,16,36,.50);
      padding:12px;
    }
    .oddsList{ display:flex; flex-direction:column; gap:8px; }
    .oddsRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(59,72,166,.28);
      background: rgba(11,16,36,.50);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease;
    }
    .oddsRow:hover{ transform: translateY(-1px); border-color: rgba(124,195,255,.60); }
    .oddsRow.active{ border-color: rgba(124,195,255,.85); box-shadow: 0 0 0 3px rgba(124,195,255,.12); }
    .oddsLeft{ display:flex; align-items:center; gap:10px; }
    .oddsName{ font-weight:900; }
    .oddsMeta{ color: var(--muted); font-size:12px; }
    .oddsVal{ font-weight:1000; font-variant-numeric: tabular-nums; }

    /* responsive */
    @media (max-width: 980px){
      body{ overflow:auto; }
      #app{ grid-template-columns: 1fr; height:auto; }
      .track{ min-height: 520px; }
    }
  </style>
</head>
<body>
<div id="app">
  <!-- LEFT: BETTING -->
  <div id="left" class="panel">
    <div class="panelHeader">
      <h3>玩家</h3>
      <div class="unitTag" id="sessionTag">第 1 场</div>
    </div>
    <div class="panelBody">
      <div class="pills">
        <div class="pill"><span class="dot gold"></span>金币 <b id="gold"></b></div>
        <div class="pill"><span class="dot turn"></span>已选 <b id="picked"></b></div>
        <div class="pill"><span class="dot mana"></span>赔率 <b id="pickedOdds"></b></div>
      </div>

      <div class="field">
        <div class="k">下注金额</div>
        <input class="input" id="betAmount" type="number" min="1" step="1" />
        <div class="hint" id="betHint">提示：下注会先扣金币，赢了按赔率返还。</div>
      </div>

      <div class="field">
        <div class="k">选择马匹（8 匹）</div>
        <div class="horseGrid" id="horsePick"></div>
      </div>

      <div style="height:12px"></div>
    <div class="row">
        <button class="btn primary" id="startRace">开始比赛</button>
        <button class="btn" id="newRace">新一局</button>
        <button class="btn" id="save">保存</button>
        <button class="btn" id="load">读取</button>
        <button class="btn" id="reset">重置</button>
      </div>
    </div>
  </div>

  <!-- CENTER: TRACK -->
  <div id="center" class="panel">
    <div class="panelHeader">
      <h3>跑道</h3>
      <div class="unitTag" id="raceStatus">待机</div>
    </div>
    <div class="panelBody">
      <div class="trackWrap">
        <div class="trackTop">
          <div class="pill"><span class="dot"></span><span id="raceTip">选一匹马并下注，然后点击开始比赛。</span></div>
          <div class="pill"><span class="dot turn"></span>领先：<b id="leader">-</b></div>
        </div>
        <div class="track" id="track">
          <div class="startLine"></div>
          <div class="finishLine"></div>
          <div class="markers"></div>
          <div class="lanes" id="lanes"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: ODDS + LOG -->
  <div id="right" class="panel">
    <div class="panelHeader">
      <h3>赔率 / 赛况</h3>
      <div class="unitTag" id="resultTag">-</div>
    </div>
    <div class="panelBody">
      <div class="oddsBox">
        <div class="previewTitle" style="margin-top:0">本场赔率</div>
        <div class="oddsList" id="oddsList"></div>
      </div>

      <div style="height:12px"></div>
      <div class="logWrap">
        <div class="panelHeader" style="padding:10px 0 0 0; border-bottom:none; background:none">
          <h3>赛况日志</h3>
          <div class="unitTag">最新</div>
        </div>
        <div id="log" aria-live="polite"></div>
      </div>
    </div>
  </div>
</div>

<!-- FX Layer -->
<div id="fxLayer" aria-hidden="true"></div>

<script>
// 赛马竞猜（8 匹马 + 跑道圆点移动 + 下注结算）

const $ = (id) => document.getElementById(id);
const nowTime = () => new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
const log = (msg, tone='') => {
  const d = document.createElement('div');
  d.className = 'logItem';
  d.innerHTML = `<div>${msg}</div><small>${nowTime()}</small>`;
  if(tone==='good') d.style.borderColor = 'rgba(78,230,168,.35)';
  if(tone==='bad') d.style.borderColor = 'rgba(255,107,139,.35)';
  $('log').prepend(d);
};

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function rand(min,max){ return Math.random()*(max-min)+min; }

function makeFxEl(className, html=''){
  const el = document.createElement('div');
  el.className = className;
  if(html) el.innerHTML = html;
  $('fxLayer').appendChild(el);
  return el;
}
function rectCenter(r){ return { x: r.left + r.width/2, y: r.top + r.height/2 }; }
function floatText(x, y, text, tone=''){
  const el = makeFxEl('floatText ' + (tone || ''), text);
  el.style.left = `${x}px`;
  el.style.top = `${y}px`;
  el.style.setProperty('--dx', `${(Math.random()*24 - 12).toFixed(0)}px`);
  el.style.setProperty('--dy', `${(-50 - Math.random()*28).toFixed(0)}px`);
  el.addEventListener('animationend', ()=> el.remove(), { once:true });
}
function burstParticles(x, y, tone=''){
  const wrap = makeFxEl('burst ' + (tone || ''));
  wrap.style.left = `${x}px`;
  wrap.style.top = `${y}px`;
  const n = 12;
  for(let i=0;i<n;i++){
    const p = document.createElement('i');
    const ang = Math.random()*Math.PI*2;
    const dist = 26 + Math.random()*38;
    p.style.setProperty('--dx', `${(Math.cos(ang)*dist).toFixed(1)}px`);
    p.style.setProperty('--dy', `${(Math.sin(ang)*dist).toFixed(1)}px`);
    p.style.setProperty('--s', `${(0.7 + Math.random()*0.7).toFixed(2)}`);
    wrap.appendChild(p);
  }
  wrap.addEventListener('animationend', ()=> wrap.remove(), { once:true });
}
function impactAt(el, tone, text){
  if(!el) return;
  const c = rectCenter(el.getBoundingClientRect());
  burstParticles(c.x, c.y, tone);
  if(text) floatText(c.x, c.y, text, tone);
}

const HORSE_COUNT = 8;
const COLORS = ['#FF6B8B', '#7CC3FF', '#4EE6A8', '#FFCE5C', '#9B7CFF', '#FF8FD6', '#7CFFEA', '#FFA86B'];
const SAVE_KEY = 'kunzz-horse-race-v1';

let state = {
  gold: 500,
  picked: 1,
  bet: 50,
  raceNo: 1,
  phase: 'idle', // idle | countdown | running | result
  running: false,
  horses: [],
  winner: null,
  winnerTs: null,
  lastTs: null,
  countdownTimer: null
};

function calcOdds(rating){
  // rating 越高越强，赔率越低
  const base = (1.75 / rating) * rand(0.92, 1.08);
  return clamp(Number(base.toFixed(2)), 1.2, 3.8);
}

function freshHorses(){
  state.horses = Array.from({length: HORSE_COUNT}, (_,i)=>{
    const id = i+1;
    const rating = Number(rand(0.92, 1.10).toFixed(3));
    const odds = calcOdds(rating);
    return {
      id,
      color: COLORS[i % COLORS.length],
      rating,
      odds,
      progress: 0,
      finished: false,
      finishTs: null
    };
  });
}

function buildUI(){
  // horse pick buttons
  const pick = $('horsePick');
  pick.innerHTML = '';
  state.horses.forEach(h=>{
    const b = document.createElement('button');
    b.className = 'horseBtn';
    b.type = 'button';
    b.innerHTML = `<span class="miniDot" style="--c:${h.color}"></span>#${h.id}`;
    b.onclick = ()=> { if(state.running || state.phase==='countdown') return; state.picked = h.id; render(); };
    pick.appendChild(b);
  });

  // lanes
  const lanes = $('lanes');
  lanes.innerHTML = '';
  state.horses.forEach(h=>{
    const lane = document.createElement('div');
    lane.className = 'lane';
    lane.innerHTML = `
      <div class="laneLabel">#${h.id}</div>
      <div class="laneLine" data-lane="${h.id}">
        <div class="horseDot" id="dot-${h.id}" style="--c:${h.color}">${h.id}</div>
      </div>
    `;
    lanes.appendChild(lane);
  });

  // odds list
  const odds = $('oddsList');
  odds.innerHTML = '';
  state.horses.forEach(h=>{
    const row = document.createElement('div');
    row.className = 'oddsRow';
    row.dataset.id = String(h.id);
    row.innerHTML = `
      <div class="oddsLeft">
        <span class="miniDot" style="--c:${h.color}"></span>
        <div>
          <div class="oddsName">马 #${h.id}</div>
          <div class="oddsMeta">强度 ${h.rating}</div>
        </div>
      </div>
      <div class="oddsVal">x${h.odds.toFixed(2)}</div>
    `;
    row.onclick = ()=> { if(state.running || state.phase==='countdown') return; state.picked = h.id; render(); };
    odds.appendChild(row);
  });
}

function resetPositions(){
  state.horses.forEach(h=>{
    h.progress = 0;
    h.finished = false;
    h.finishTs = null;
    const dot = $(`dot-${h.id}`);
    if(dot){
      dot.classList.remove('finished');
      dot.style.setProperty('--x', `0px`);
    }
  });
  $('leader').textContent = '-';
  $('resultTag').textContent = '-';
  state.winner = null;
  state.winnerTs = null;
}

function laneMaxX(id){
  const laneLine = document.querySelector(`.laneLine[data-lane="${id}"]`);
  const dot = $(`dot-${id}`);
  if(!laneLine || !dot) return 0;
  return Math.max(0, laneLine.clientWidth - dot.offsetWidth - 2);
}

function updatePositions(){
  state.horses.forEach(h=>{
    const dot = $(`dot-${h.id}`);
    if(!dot) return;
    const x = laneMaxX(h.id) * h.progress;
    dot.style.setProperty('--x', `${x.toFixed(1)}px`);
    if(h.finished) dot.classList.add('finished');
  });
}

function updateLeader(){
  const finished = state.horses.filter(h=>h.finished).sort((a,b)=>a.finishTs-b.finishTs);
  if(finished.length){
    $('leader').textContent = `#${finished[0].id}（已冲线）`;
    return;
  }
  const lead = state.horses.slice().sort((a,b)=>b.progress-a.progress)[0];
  $('leader').textContent = lead ? `#${lead.id}` : '-';
}

function setStatus(text){
  $('raceStatus').textContent = text;
}

function setTip(text){
  $('raceTip').textContent = text;
}

function validateBet(showHint=true){
  const bet = Number.parseInt($('betAmount').value || '0', 10);
  const ok = Number.isFinite(bet) && bet >= 1 && bet <= state.gold;
  if(showHint){
    $('betHint').textContent = ok ? '提示：下注会先扣金币，赢了按赔率返还。' : `下注必须在 1 ~ ${state.gold} 之间`;
    $('betHint').style.color = ok ? 'var(--muted)' : 'rgba(255,107,139,.9)';
  }
  return ok ? bet : null;
}

function render(){
  $('gold').textContent = state.gold;
  $('sessionTag').textContent = `第 ${state.raceNo} 场`;

  const pickedHorse = state.horses.find(h=>h.id===state.picked);
  $('picked').textContent = `#${state.picked}`;
  $('pickedOdds').textContent = pickedHorse ? `x${pickedHorse.odds.toFixed(2)}` : '-';

  $('betAmount').value = String(state.bet);

  // active highlight
  document.querySelectorAll('.horseBtn').forEach((b, idx)=>{
    const id = idx+1;
    b.classList.toggle('active', id === state.picked);
  });
  document.querySelectorAll('.oddsRow').forEach(row=>{
    row.classList.toggle('active', Number(row.dataset.id) === state.picked);
  });

  const lock = state.running || state.phase === 'countdown';
  $('startRace').disabled = lock;
  $('newRace').disabled = lock;
  $('save').disabled = lock;
  $('load').disabled = lock;
  $('reset').disabled = lock;
  $('betAmount').disabled = lock;
  updatePositions();
  updateLeader();
}

function countdownThenStart(){
  state.phase = 'countdown';
  setStatus('倒计时');
  setTip('准备起跑…');

  let t = 3;
  const track = $('track');
  const c = rectCenter(track.getBoundingClientRect());
  const tick = ()=>{
    if(t > 0){
      floatText(c.x, c.y, String(t), 'good');
      t--;
      return;
    }
    floatText(c.x, c.y, 'GO!', 'good');
    clearInterval(state.countdownTimer);
    state.countdownTimer = null;
    beginRun();
  };
  tick();
  state.countdownTimer = setInterval(tick, 1000);
}

function beginRun(){
  state.phase = 'running';
  state.running = true;
  state.lastTs = null;
  state.winner = null;
  state.winnerTs = null;
  setStatus('比赛中');
  setTip('比赛进行中…看谁先到终点！');
  log(`比赛开始：你下注了 <b>#${state.picked}</b>（${state.bet} 金币）`, '');
  requestAnimationFrame(loop);
  render();
}

function finishRace(){
  state.running = false;
  state.phase = 'result';
  setStatus('结束');

  const order = state.horses
    .slice()
    .sort((a,b)=>{
      if(a.finished && b.finished) return a.finishTs - b.finishTs;
      if(a.finished) return -1;
      if(b.finished) return 1;
      return b.progress - a.progress;
    });
  const winner = order[0];
  state.winner = winner?.id ?? null;
  $('resultTag').textContent = winner ? `冠军：#${winner.id}` : '-';

  if(winner){
    const pickedHorse = state.horses.find(h=>h.id===state.picked);
    if(state.picked === winner.id){
      const payout = Math.floor(state.bet * (pickedHorse?.odds ?? 1));
      state.gold += payout;
      log(`你赢了！冠军是 <b>#${winner.id}</b>，获得 <b>+${payout}</b> 金币`, 'good');
      impactAt($(`dot-${winner.id}`), 'good', `+${payout}`);
    }else{
      log(`你输了：冠军是 <b>#${winner.id}</b>，你选择的是 <b>#${state.picked}</b>（-${state.bet}）`, 'bad');
      impactAt($(`dot-${winner.id}`), 'bad', `#${winner.id} 冠军`);
    }
  }

  setTip('比赛结束：可以新一局或继续下注。');
  render();
}

function loop(ts){
  if(!state.running) return;
  if(state.lastTs == null) state.lastTs = ts;
  const dt = Math.min(0.05, (ts - state.lastTs) / 1000);
  state.lastTs = ts;

  // update progress
  for(const h of state.horses){
    if(h.finished) continue;

    // 基础速度由 rating 决定，加入波动和冲刺
    const base = 0.11 + (h.rating - 0.92) * 0.06; // ~0.11..0.12+
    const wobble = rand(-0.022, 0.022);
    const surge = Math.random() < 0.028 ? rand(0.03, 0.065) : 0;
    const fatigue = h.progress > 0.82 ? -0.03 : 0;
    const v = Math.max(0.03, base + wobble + surge + fatigue);

    h.progress = clamp(h.progress + v * dt, 0, 1);
    if(h.progress >= 1){
      h.finished = true;
      h.finishTs = ts;
      const dot = $(`dot-${h.id}`);
      dot?.classList.add('finished');
      impactAt(dot, 'good', `#${h.id} 冲线`);
      log(`马 <b>#${h.id}</b> 冲线！`, '');

      if(state.winner == null){
        state.winner = h.id;
        state.winnerTs = ts;
        $('resultTag').textContent = `领先：#${h.id}`;
      }
    }
  }

  updatePositions();
  updateLeader();

  const allFinished = state.horses.every(h=>h.finished);
  if(allFinished){
    finishRace();
    return;
  }
  if(state.winnerTs != null && ts - state.winnerTs > 3500){
    // 让大家再跑一会儿就结算，避免拖太久
    finishRace();
    return;
  }

  requestAnimationFrame(loop);
}

function startRace(){
  if(state.running || state.phase==='countdown') return;
  const bet = validateBet(true);
  if(bet == null) return;
  state.bet = bet;
  if(state.gold < bet) return;

  // reset race positions before starting
  resetPositions();
  updatePositions();

  // take bet
  state.gold -= bet;
  $('resultTag').textContent = '-';
  render();
  countdownThenStart();
}

function newRace(){
  if(state.running || state.phase==='countdown') return;
  state.raceNo += 1;
  freshHorses();
  buildUI();
  resetPositions();
  setStatus('待机');
  setTip('新一局已生成：重新选择马匹并下注。');
  log(`新一局：第 ${state.raceNo} 场已生成（赔率已更新）`, '');
  render();
}

function resetAll(){
  if(state.running || state.phase==='countdown') return;
  state.gold = 500;
  state.bet = 50;
  state.picked = 1;
  state.raceNo = 1;
  state.phase = 'idle';
  state.running = false;
  state.winner = null;
  state.winnerTs = null;
  $('log').innerHTML = '';
  freshHorses();
  buildUI();
  resetPositions();
  setStatus('待机');
  setTip('已重置。');
  log('已重置为初始状态。', '');
  render();
}

function normalizeLoaded(s){
  const out = {};
  out.gold = Number.isFinite(s.gold) ? Math.max(0, Math.floor(s.gold)) : 500;
  out.bet = Number.isFinite(s.bet) ? Math.max(1, Math.floor(s.bet)) : 50;
  out.picked = Number.isFinite(s.picked) ? clamp(Math.floor(s.picked), 1, HORSE_COUNT) : 1;
  out.raceNo = Number.isFinite(s.raceNo) ? Math.max(1, Math.floor(s.raceNo)) : 1;
  out.horses = Array.isArray(s.horses) && s.horses.length === HORSE_COUNT ? s.horses : null;
  return out;
}

function save(){
  const payload = {
    gold: state.gold,
    bet: state.bet,
    picked: state.picked,
    raceNo: state.raceNo,
    horses: state.horses.map(h=>({ id:h.id, color:h.color, rating:h.rating, odds:h.odds }))
  };
  localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
  log('已保存到本地。', 'good');
}

function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){
    log('没有找到存档。', 'bad');
    return;
  }
  try{
    const s = normalizeLoaded(JSON.parse(raw));
    state.gold = s.gold;
    state.bet = s.bet;
    state.picked = s.picked;
    state.raceNo = s.raceNo;

    if(s.horses){
      state.horses = s.horses.map((h, i)=>({
        id: i+1,
        color: h.color || COLORS[i%COLORS.length],
        rating: Number(h.rating) || Number(rand(0.92, 1.10).toFixed(3)),
        odds: Number(h.odds) || calcOdds(Number(h.rating) || 1),
        progress: 0, finished:false, finishTs:null
      }));
    }else{
      freshHorses();
    }

    buildUI();
    resetPositions();
    setStatus('待机');
    setTip('已读取存档：可以直接开始比赛。');
    log('已读取存档。', 'good');
    render();
  }catch{
    log('读取失败：存档损坏。', 'bad');
  }
}

// Wire up
$('startRace').onclick = startRace;
$('newRace').onclick = newRace;
$('reset').onclick = resetAll;
$('save').onclick = save;
$('load').onclick = load;
$('betAmount').addEventListener('input', ()=>{
  const bet = validateBet(true);
  if(bet != null) state.bet = bet;
});
window.addEventListener('resize', ()=> updatePositions());

// Boot
freshHorses();
buildUI();
resetPositions();
setStatus('待机');
setTip('选一匹马并下注，然后点击开始比赛。');
log('欢迎来到赛马竞猜：请选择 1~8 号马并下注。', '');
render();
</script>
</body>
</html>